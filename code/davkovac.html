<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <title> Collapsable example </title>
    <link rel="stylesheet" href="Treant.css">
    <link rel="stylesheet" href="collapsable.css">
    <link rel="stylesheet" href="vendor/perfect-scrollbar/perfect-scrollbar.css">
</head>
<body>
    <div class="chart" id="collapsable-example"></div>
    <script src="vendor/raphael.js"></script>
    <script src="Treant.js"></script>

    <script src="vendor/jquery.min.js"></script>
    <script src="vendor/jquery.easing.js"></script>

    
    <script>
        /*
        subor musi byt umiestnenÃ½ spolu s collapsable.css v rovnakej zlozke ako je na ich gite treant.js aby sa vsetko spravne nacitalo... je to cisto pre dokazanie funkcnosti trieda ide ak ju premiestnite inam
        Funkcie co potrebujete:
            -extra info nieje zavysle od davkovaca ale mozu byt v nom ulozene, povazujem ze do pola podla indexu vramci struktury vlozite pole extra informacii[datum pridania, sluzba,datum zaplatenia]
            -addSon zavolaj na kazdeho z databazy spolu s jeho hlavnymi udajmi, jeho id, id otca, zarobok, meno, po pridani vsetkych synov treba zavolat  x.updateParents(); x.updateNumber(); aby sa korektne volalo prepisanie a fungovalo zobrazenie
            -createTree vrati strukturu rovno s configom a synami len to prilepte ako novy config
            - nextSons prepne na dalsich 10 synov otca alebo na jeho prvych ak dalsich nema 
        kratky example davkovaca mozete si pozriet nizsie
        display number = kolko sa ich ma zobrazovat
        do clicked dajte vzdy ID syna ktory bol naposledny kliknuty
        Co este musim - pridat nacitanie posledne kliknuteho...
        */
        function davkovac(id) {
            this.extraInfo = [];
            this.parts = [];
            this.mainPart = id;
            this.showing = [];
            this.numberOfSons = [];
            this.clicked = id;
            this.usedID = [];
            this.displayNumber = 10;
            this.config = {
                container: "#collapsable-example",
                animateOnInit: true,

                node: {
                    collapsable: true
                },
                animation: {
                    nodeAnimation: "easeOutBounce",
                    nodeSpeed: 700,
                    connectorsAnimation: "bounce",
                    connectorsSpeed: 700
                }
            }
            this.addSon(id, id, 0, "Ja",null,null,null);

        }
        davkovac.prototype.changeConfig = function () {
            this.config = {
                container: "#collapsable-example",
                animateOnInit: false,

                node: {
                    collapsable: true
                },
                animation: {
                    nodeAnimation: "easeOutBounce",
                    nodeSpeed: 700,
                    connectorsAnimation: "bounce",
                    connectorsSpeed: 700
                }
            }
        }


        davkovac.prototype.getInfo = function (id) {
            return this.extraInfo[id];
        }
        davkovac.prototype.addInfo = function (id, info) {
            return this.extraInfo[id] = info;
        }

        davkovac.prototype.addSon = function (myID, fatherID, zarobok, meno,datumUz,prog,datumKon) {
            if (myID != this.mainPart) {
                part = {
                    datumUzavretia:datumUz,
                    program: prog,
                    datumKoncaZmluvy: datumKon,
                    id:myID,
                    parent: fatherID,
                    text: {
                        name: zarobok,
                        title: meno,
                    }                    
                }
            }
            else {
                part = {
                    id:myID,
                    text: {
                        collapsed: true,
                        title: meno,
                    }
                }
            }
            this.parts[myID] = part;
            this.showing[myID] = 0;
        }

        davkovac.prototype.updateNumber = function () {
            var iterator = this.parts.keys()
            var iter = iterator.next()
            while (!iter.done) {
                var part = this.getSon(iter.value);
                if (part != undefined) {
                    this.numberOfSons[iter.value] = this.numberOfHisSons(part);
                }
                iter = iterator.next();
            }
        }
        davkovac.prototype.numberOfHisSons = function (compare) {
            var pocet = 0;
            var iterator = this.parts.keys()
            var iter = iterator.next()
            while (!iter.done) {
                var part = this.getSon(iter.value);
                if (part != undefined) {
                    if (part.parent == compare) {
                        pocet++;
                    }
                }
                iter = iterator.next();
            }

            return pocet;
        }
        davkovac.prototype.getSon = function (id) {
            return this.parts[id];
        }
        davkovac.prototype.nextSons = function (fatherID) {
            var father = this.getSon(fatherID);
            if (this.numberOfSons[fatherID] - (this.showing[fatherID] + 1) * this.displayNumber > 0) {
                this.showing[fatherID] = this.showing[fatherID] + 1;
            }
            else {
                this.showing[fatherID] = 0;
            }
        }

        davkovac.prototype.getParents = function () {
            var result = [];
            var iterator = this.parts.keys();
            var iter = iterator.next();
            while (!iter.done) {
                var part = this.getSon(iter.value);
                if (part != undefined && part != this.getSon(this.mainPart)) {
                    if (result[this.parts.indexOf(part.parent)] == undefined) {
                        result[this.parts.indexOf(part.parent)] = [];
                    }
                    result[this.parts.indexOf(part.parent)].push(part);
                }
                iter = iterator.next();
            }
            return this.stripSons(result);
            //return result;
        }

        davkovac.prototype.stripSons = function (fatherField) {
            var result = [];
            var iterator = fatherField.keys();
            var iter = iterator.next();
            var selected = 0;
            while (!iter.done) {
                var part = fatherField[iter.value];
                if (part != undefined) {
                    x.parts[iter.value].collapsed = true;
                
                    result[iter.value] = [];
                    selected = 0;
                    var next = fatherField[iter.value][selected + this.showing[iter.value] * this.displayNumber];
                    while (!(selected == this.displayNumber || next == undefined)) {
                        result[iter.value][selected] = next;
                        selected++;
                        next = fatherField[iter.value][selected + this.showing[iter.value] * this.displayNumber];
                        //console.log(selected);
                    }
                }
                iter = iterator.next();
            }
            return this.stripFathers(result);
        }

        davkovac.prototype.uncollapse = function (resArray) {
            if (this.clicked == this.mainPart) {
                return resArray;
            }
            nextParent=this.parts[this.clicked];
            while (nextParent != this.parts[this.mainPart]) {
                resArray[resArray.indexOf(nextParent)].collapsed = false;
                nextParent = nextParent.parent;
            }
            return resArray;
        }

        davkovac.prototype.stripFathers = function (fatherField) {
            var result = fatherField[this.mainPart];
            var toPass = fatherField[this.mainPart];
            var nextToPass = [];
            while (toPass.length != 0) {
                nextToPass = [];
                var self = this;
                toPass.forEach(function (item) {
                    if (fatherField[self.parts.indexOf(item)] != undefined) {
                        nextToPass = nextToPass.concat(fatherField[self.parts.indexOf(item)]);
                        result = result.concat(fatherField[self.parts.indexOf(item)]);
                    }
                })

                toPass = nextToPass;
            }

            return result;
        }

        davkovac.prototype.createTree = function () {
            
            var result = [];
            result.push(this.config);
            result.push(this.parts[this.mainPart]);
            result = result.concat(this.uncollapse(this.getParents()));
            this.createUsedID(result);
            return result;
        }

        davkovac.prototype.createUsedID=function(pole){
            this.usedID = [];
            for (i = 1; i < pole.length; i++) {
                //console.log(pole[i]);
                this.usedID[i-1]=pole[i].id;
            }
        }

        davkovac.prototype.updateParents = function () {
            var self = this;
            this.parts.forEach(function (part) {
                if (part.parent != undefined) {
                    part.parent = self.parts[part.parent];
                }
            })
        }
        x = new davkovac(10);
        x.addSon(1, 10, 12, "nom1",null,null,null);
        x.addSon(2, 10, 12, "nom2", null, null, null);
        x.addSon(4, 10, 12, "nom3", null, null, null);
        x.addSon(41, 10, 12, "nom4", null, null, null);
        x.addSon(42, 10, 12, "nom5", null, null, null);
        x.addSon(43, 10, 12, "nom6", null, null, null);
        x.addSon(44, 10, 12, "nom7", null, null, null);
        x.addSon(45, 10, 12, "nom8", null, null, null);
        x.addSon(46, 10, 12, "nom9", null, null, null);
        x.addSon(47, 10, 12, "nom10", null, null, null);
        x.addSon(48, 10, 12, "nom11", null, null, null);
        x.addSon(49, 10, 12, "nom12", null, null, null);
        x.addSon(50, 10, 12, "nom13", null, null, null);
        x.addSon(3, 2, 12, "XXX1", null, null, null);
        x.addSon(5, 2, 12, "XXX2", null, null, null);
        x.addSon(6, 2, 12, "XXX3", null, null, null);
        x.addSon(7, 6, 12, "XXX3", null, null, null);
        x.updateParents();
        x.updateNumber();
        x.nextSons(10);
        x.nextSons(10);
        x.clicked = 7;
        y = new Treant(x.createTree(),function() {}, $);
        //y = x.createTree();
    </script>
</body>
</html>
